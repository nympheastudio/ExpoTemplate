{"version":3,"file":"BuildFunction.js","sourceRoot":"","sources":["../src/BuildFunction.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from 'assert';\n\nimport { BuildRuntimePlatform } from './BuildRuntimePlatform.js';\nimport { BuildStep, BuildStepFunction } from './BuildStep.js';\nimport { BuildStepGlobalContext } from './BuildStepContext.js';\nimport { BuildStepInputProvider, BuildStepInputValueTypeWithRequired } from './BuildStepInput.js';\nimport { BuildStepOutputProvider } from './BuildStepOutput.js';\nimport { BuildStepEnv } from './BuildStepEnv.js';\nimport { createCustomFunctionCall } from './utils/customFunction.js';\n\nexport type BuildFunctionById = Record<string, BuildFunction>;\nexport type BuildFunctionCallInputs = Record<string, BuildStepInputValueTypeWithRequired>;\n\nexport class BuildFunction {\n  public readonly namespace?: string;\n  public readonly id: string;\n  public readonly name?: string;\n  public readonly supportedRuntimePlatforms?: BuildRuntimePlatform[];\n  public readonly inputProviders?: BuildStepInputProvider[];\n  public readonly outputProviders?: BuildStepOutputProvider[];\n  public readonly command?: string;\n  public readonly customFunctionModulePath?: string;\n  public readonly fn?: BuildStepFunction;\n  public readonly shell?: string;\n\n  constructor({\n    namespace,\n    id,\n    name,\n    supportedRuntimePlatforms,\n    inputProviders,\n    outputProviders,\n    command,\n    fn,\n    customFunctionModulePath,\n    shell,\n  }: {\n    namespace?: string;\n    id: string;\n    name?: string;\n    supportedRuntimePlatforms?: BuildRuntimePlatform[];\n    inputProviders?: BuildStepInputProvider[];\n    outputProviders?: BuildStepOutputProvider[];\n    command?: string;\n    customFunctionModulePath?: string;\n    fn?: BuildStepFunction;\n    shell?: string;\n  }) {\n    assert(\n      command !== undefined || fn !== undefined || customFunctionModulePath !== undefined,\n      'Either command, fn or path must be defined.'\n    );\n\n    assert(!(command !== undefined && fn !== undefined), 'Command and fn cannot be both set.');\n    assert(\n      !(command !== undefined && customFunctionModulePath !== undefined),\n      'Command and path cannot be both set.'\n    );\n    assert(\n      !(fn !== undefined && customFunctionModulePath !== undefined),\n      'Fn and path cannot be both set.'\n    );\n\n    this.namespace = namespace;\n    this.id = id;\n    this.name = name;\n    this.supportedRuntimePlatforms = supportedRuntimePlatforms;\n    this.inputProviders = inputProviders;\n    this.outputProviders = outputProviders;\n    this.command = command;\n    this.fn = fn;\n    this.shell = shell;\n    this.customFunctionModulePath = customFunctionModulePath;\n  }\n\n  public getFullId(): string {\n    return this.namespace === undefined ? this.id : `${this.namespace}/${this.id}`;\n  }\n\n  public createBuildStepFromFunctionCall(\n    ctx: BuildStepGlobalContext,\n    {\n      id,\n      name,\n      callInputs = {},\n      workingDirectory,\n      shell,\n      env,\n      ifCondition,\n    }: {\n      id?: string;\n      name?: string;\n      callInputs?: BuildFunctionCallInputs;\n      workingDirectory?: string;\n      shell?: string;\n      env?: BuildStepEnv;\n      ifCondition?: string;\n    } = {}\n  ): BuildStep {\n    const buildStepId = BuildStep.getNewId(id);\n    const buildStepName = name ?? this.name;\n    const buildStepDisplayName = BuildStep.getDisplayName({\n      id: buildStepId,\n      command: this.command,\n      name: buildStepName,\n    });\n\n    const inputs = this.inputProviders?.map((inputProvider) => {\n      const input = inputProvider(ctx, buildStepId);\n      if (input.id in callInputs) {\n        input.set(callInputs[input.id]);\n      }\n      return input;\n    });\n    const outputs = this.outputProviders?.map((outputProvider) => outputProvider(ctx, buildStepId));\n\n    return new BuildStep(ctx, {\n      id: buildStepId,\n      name: buildStepName,\n      displayName: buildStepDisplayName,\n      command: this.command,\n      fn:\n        this.fn ??\n        (this.customFunctionModulePath\n          ? createCustomFunctionCall(this.customFunctionModulePath)\n          : undefined),\n      workingDirectory,\n      inputs,\n      outputs,\n      shell,\n      supportedRuntimePlatforms: this.supportedRuntimePlatforms,\n      env,\n      ifCondition,\n    });\n  }\n}\n"]}